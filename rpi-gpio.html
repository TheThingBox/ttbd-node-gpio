<style>
    .rpi-gpio-pinTable {
        width: 340px;
        display: inline-table;
        font-size: 13px;
        height: 380px;
        min-height: 380px;
        max-height: 380px;
    }
    .rpi-gpio-pinTable input[type="radio"] {
        width: auto;
        margin: 2px 2px;
    }
    .rpi-gpio-pinTable label {
        width: auto;
        margin: 0;
        display: block;
    }
    .rpi-gpio-pinTable .pinTableBody {
        width: 340px;
        display: table-row-group;
        line-height: 12px;
    }
    .rpi-gpio-pinTable .ledTableBody {
        width: 340px;
        display: table-caption;
        line-height: 12px;
        margin-bottom: 8px;
    }
    .rpi-gpio-pinTable .pinTableRow {
        width: 340px;
        display: table-row;
        height: 14px;
    }

    .rpi-gpio-pinTable .ledTableCell {
        width: 340px;
        display: table-cell;
        text-align: center;
        vertical-align: top;
        border: 1px solid #444;
        border-bottom-style: none;
        border-left-style: none;
    }
    .rpi-gpio-pinTable .pinTableCellL {
        width: 170px;
        display: table-cell;
        text-align: right;
        padding-right: 4px;
        vertical-align: top;
        border: 1px solid #444;
        border-bottom-style: none;
    }
    .rpi-gpio-pinTable .pinTableCellR {
        width: 170px;
        display: table-cell;
        text-align: left;
        padding-left: 4px;
        vertical-align: top;
        border: 1px solid #000;
        border-bottom-style: none;
        border-left-style: none;
    }
    .rpi-gpio-pinTable .lastrow {
      border-bottom-style: solid;
    }
    .rpi-gpio-pinTable .ledTableCell.firstcol {
        border-left-style: solid;
    }
    .rpi-gpio-pinTable .pinColorPower {
        background-color:#FECBCE;
    }
    .rpi-gpio-pinTable .pinColorGround {
        background-color:#DDDDDD;
    }
    .rpi-gpio-pinTable .pinColorLed {
        background-color:#8edb8e;
    }
    .rpi-gpio-pinTable .pinColorGPIO {
        background-color:#BFEBBF;
    }
    .rpi-gpio-pinTable .pinColorGPIO2 {
        background-color:#8edb8e;
    }
    .rpi-gpio-pinTable .pinColorDual {
        background-color:#D0E6F4;
    }
    .rpi-gpio-pinTable .pinColorSD {
        background-color:#FFFDD0;
    }
</style>
<script type="text/x-red" data-template-name="rpi-gpio in">
  <div class="form-row">
    <ul style="background: #fff; min-width: 600px; margin-bottom: 20px;" id="ttbd-node-gpio-in-tabs"></ul>
  </div>
  <div id="ttbd-node-gpio-in-tabs-content" style="min-height: 170px;">
    <div id="ttbd-node-gpio-in-tab-configuration" style="display:none">
      <div class="form-row" style="min-width: 540px">
          <label><i class="fa fa-circle"></i> <span data-i18n="rpi-gpio.pinname"></span></label>
          <input type="text" id="node-input-pin" style="display:none;">
          <input type="hidden" id="node-input-piModel">
          <div class="rpi-gpio-pinTable" id="pinform_cm" style="display:none;">
              <div class="ledTableBody">
                  <div class="pinTableRow">
                      <div class="ledTableCell pinColorLed lastrow firstcol"><label>Led 1 <input type="radio" name="pins" value="52"></label></div>
                      <div class="ledTableCell pinColorLed lastrow"><label>Led 2 <input type="radio" name="pins" value="54"></label></div>
                      <div class="ledTableCell pinColorLed lastrow"><label>Led 3 <input type="radio" name="pins" value="58"></label></div>
                  </div>
              </div>
              <div class="pinTableBody">
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO"><label>TIC 1 <input disabled type="radio" name="pins" value=""></label></div>
                      <div class="pinTableCellR pinColorPower"><label><input disabled type="radio" name="pins" value=""> 24VDC Power</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO"><label>TIC 2 <input disabled type="radio" name="pins" value=""></label></div>
                      <div class="pinTableCellR pinColorPower"><label><input disabled type="radio" name="pins" value=""> 24VDC Power</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorDual"><label>ES 4/20mA A <input disabled type="radio" name="pins" value=""></label></div>
                      <div class="pinTableCellR pinColorGround"><label><input disabled type="radio" name="pins" value=""> Ground</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorDual"><label>ES 4/20mA B <input disabled type="radio" name="pins" value=""></label></div>
                      <div class="pinTableCellR pinColorGround"><label><input disabled type="radio" name="pins" value=""> Ground</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorDual"><label>+ RS485 <input disabled type="radio" name="pins" value=""></label></div>
                      <div class="pinTableCellR pinColorGround"><label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorDual"><label>- RS485 <input disabled type="radio" name="pins" value=""></label></div>
                      <div class="pinTableCellR pinColorGround lastrow"><label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO"><label>- ES TOR1 <input disabled type="radio" name="pins" value=""></label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO"><label>+ ES TOR1 <input id="pinTable-pin-36" type="radio" name="pins" value="36"></label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO2"><label>- ES TOR2 <input disabled type="radio" name="pins" value=""></label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO2"><label>+ ES TOR2 <input id="pinTable-pin-46" type="radio" name="pins" value="46"></label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO"><label>- ES TOR3 <input disabled type="radio" name="pins" value=""></label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO"><label>+ ES TOR3 <input id="pinTable-pin-48" type="radio" name="pins" value="48"></label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO2"><label>NC - Relais 1 <input disabled type="radio" name="pins" value=""></label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO2"><label>COM - Relais 1 <input id="pinTable-pin-21" type="radio" name="pins" value="21"></label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO2"><label>NO - Relais 1 <input disabled type="radio" name="pins" value=""></label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO"><label>NC - Relais 2 <input disabled type="radio" name="pins" value=""></label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO"><label>COM - Relais 2 <input id="pinTable-pin-45" type="radio" name="pins" value="45"></label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO lastrow"><label>NO - Relais 2 <input disabled type="radio" name="pins" value=""></label></div>
                  </div>
              </div>
          </div>
          <div class="rpi-gpio-pinTable" id="pinform_b" style="display:none;">
              <div class="pinTableBody">
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorPower"><label>3.3V Power - 1 <input disabled type="radio" name="pins" value=""></label></div>
                      <div class="pinTableCellR pinColorPower"><label><input disabled type="radio" name="pins" value=""> 2 - 5V Power</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorDual"><label for="pinTable-pin-3">SDA1 - GPIO02 - 3 <input id="pinTable-pin-3" type="radio" name="pins" value="3"></label></div>
                      <div class="pinTableCellR pinColorPower"><label><input disabled type="radio" name="pins" value=""> 4 - 5V Power</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorDual"><label for="pinTable-pin-5">SCL1 - GPIO03 - 5 <input id="pinTable-pin-5" type="radio" name="pins" value="5"></label></div>
                      <div class="pinTableCellR pinColorGround"><label><input disabled type="radio" name="pins" value=""> 6 - Ground</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO"><label for="pinTable-pin-7">GPIO04 - 7 <input id="pinTable-pin-7" type="radio" name="pins" value="7"></label></div>
                      <div class="pinTableCellR pinColorDual"><label for="pinTable-pin-8"><input id="pinTable-pin-8" type="radio" name="pins" value="8"> 8 - GPIO14 - TxD</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGround"><label>Ground - 9 <input disabled type="radio" name="pins" value=""></label></div>
                      <div class="pinTableCellR pinColorDual"><label for="pinTable-pin-10"><input id="pinTable-pin-10" type="radio" name="pins" value="10"> 10 - GPIO15 - RxD</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO"><label for="pinTable-pin-11">GPIO17 - 11 <input id="pinTable-pin-11" type="radio" name="pins" value="11"></label></div>
                      <div class="pinTableCellR pinColorGPIO"><label for="pinTable-pin-12"><input id="pinTable-pin-12" type="radio" name="pins" value="12"> 12 - GPIO18</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO"><label for="pinTable-pin-13">GPIO27 - 13 <input id="pinTable-pin-13" type="radio" name="pins" value="13"></label></div>
                      <div class="pinTableCellR pinColorGround"><label><input disabled type="radio" name="pins" value=""> 14 - Ground</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO"><label for="pinTable-pin-15">GPIO22 - 15 <input id="pinTable-pin-15" type="radio" name="pins" value="15"></label></div>
                      <div class="pinTableCellR pinColorGPIO"><label for="pinTable-pin-16"><input id="pinTable-pin-16" type="radio" name="pins" value="16"> 16 - GPIO23</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorPower"><label>3.3V Power - 17 <input disabled type="radio" name="pins" value=""></label></div>
                      <div class="pinTableCellR pinColorGPIO"><label for="pinTable-pin-18"><input id="pinTable-pin-18" type="radio" name="pins" value="18"> 18 - GPIO24</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorDual"><label for="pinTable-pin-19">MOSI - GPIO10 - 19 <input id="pinTable-pin-19" type="radio" name="pins" value="19"></label></div>
                      <div class="pinTableCellR pinColorGround"><label><input disabled type="radio" name="pins" value=""> 20 - Ground</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorDual"><label for="pinTable-pin-21">MISO - GPIO09 - 21 <input id="pinTable-pin-21" type="radio" name="pins" value="21"></label></div>
                      <div class="pinTableCellR pinColorGPIO"><label for="pinTable-pin-22"><input id="pinTable-pin-22" type="radio" name="pins" value="22"> 22 - GPIO25</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorDual"><label for="pinTable-pin-23">SCLK - GPIO11 - 23 <input id="pinTable-pin-23" type="radio" name="pins" value="23"></label></div>
                      <div class="pinTableCellR pinColorDual"><label for="pinTable-pin-24"><input id="pinTable-pin-24" type="radio" name="pins" value="24"> 24 - GPIO8 - CE0</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGround"><label>Ground - 25 <input disabled type="radio" name="pins" value=""></label></div>
                      <div class="pinTableCellR pinColorDual"><label for="pinTable-pin-26"><input id="pinTable-pin-26" type="radio" name="pins" value="26"> 26 - GPIO7 - CE1</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorSD"><label>SD - 27 <input disabled type="radio" name="pins" value=""></label></div>
                      <div class="pinTableCellR pinColorSD"><label><input disabled type="radio" name="pins" value=""> 28 - SC</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO"><label for="pinTable-pin-29">GPIO05 - 29 <input id="pinTable-pin-29" type="radio" name="pins" value="29"></label></div>
                      <div class="pinTableCellR pinColorGround"><label><input disabled type="radio" name="pins" value=""> 30 - Ground</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO"><label for="pinTable-pin-31">GPIO06 - 31 <input id="pinTable-pin-31" type="radio" name="pins" value="31"></label></div>
                      <div class="pinTableCellR pinColorGPIO"><label for="pinTable-pin-32"><input id="pinTable-pin-32" type="radio" name="pins" value="32"> 32 - GPIO12</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO"><label for="pinTable-pin-33">GPIO13 - 33 <input id="pinTable-pin-33" type="radio" name="pins" value="33"></label></div>
                      <div class="pinTableCellR pinColorGround"><label><input disabled type="radio" name="pins" value=""> 34 - Ground</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO"><label for="pinTable-pin-35">GPIO19 - 35 <input id="pinTable-pin-35" type="radio" name="pins" value="35"></label></div>
                      <div class="pinTableCellR pinColorGPIO"><label for="pinTable-pin-36"><input id="pinTable-pin-36" type="radio" name="pins" value="36"> 36 - GPIO16</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO"><label for="pinTable-pin-37">GPIO26 - 37 <input id="pinTable-pin-37" type="radio" name="pins" value="37"></label></div>
                      <div class="pinTableCellR pinColorGPIO"><label for="pinTable-pin-38"><input id="pinTable-pin-38" type="radio" name="pins" value="38"> 38 - GPIO20</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGround lastrow"><label>Ground - 39 <input disabled type="radio" name="pins" value=""></label></div>
                      <div class="pinTableCellR pinColorGPIO lastrow"><label for="pinTable-pin-40"><input id="pinTable-pin-40" type="radio" name="pins" value="40"> 40 - GPIO21</label></div>
                  </div>
              </div>
          </div>
      </div>
      <div class="form-row">
          <label>&nbsp;</label>
          <input type="checkbox" id="node-input-read" style="display: inline-block; width: auto; vertical-align: top;">
          <label for="node-input-read" style="width:70%;"><span data-i18n="rpi-gpio.label.readinitial"></span></label>
      </div>
      <div class="form-row">
          <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="rpi-gpio.label.name"></span></label>
          <input type="text" id="node-input-name" data-i18n="[placeholder]rpi-gpio.label.name">
      </div>
      <div class="form-tips" id="pin-tip"><span data-i18n="[html]rpi-gpio.tip.pin"></span></div>
      <div class="form-tips"><span data-i18n="[html]rpi-gpio.tip.in"></span></div>
    </div>
    <div id="ttbd-node-gpio-in-tab-advanced" style="display:none">
      <div class="form-row">
        <label for="node-input-broker"><i class="fa fa-globe"></i> <span>Broker</span></label>
        <input type="text" id="node-input-broker">
      </div>
    </div>
  </div>
</script>

<script type="text/x-red" data-help-name="rpi-gpio in">
    <p>Raspberry Pi input node. Generates a <code>msg.payload</code> with either a
    0 or 1 depending on the state of the input pin.</p>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">number</span></dt>
        <dd>the payload will be a 1 or a 0.</dd>
        <dt>topic <span class="property-type">string</span></dt>
        <dd>the topic will be set to <code>pi/{the pin number}</code>.</dd>
    </dl>
</script>

<script type="text/javascript">
    var bcm2pin = {}
    bcm2pin.b = {
        "2":"3", "3":"5", "4":"7", "14":"8", "15":"10", "17":"11", "18":"12", "27":"13", "22":"15",
        "23":"16", "24":"18", "10":"19", "9":"21", "25":"22", "11":"23", "8":"24", "7":"26",
        "5":"29", "6":"31", "12":"32", "13":"33", "19":"35", "16":"36", "26":"37", "20":"38", "21":"40"
    };
    var pinsInUse = {};
    RED.nodes.registerType('rpi-gpio in',{
        category: 'hardware',
        color:"#c6dbef",
        defaults: {
            name: { value:"" },
            pin: { value:"tri",required:true,validate:RED.validators.number() },
            read: { value:false },
            broker: {value: "MQTT.Localhost", type: "mqtt-broker", required: true},
            piModel: { value:"" },
        },
        inputs:0,
        outputs:1,
        icon: "gpio.png",
        info: function() {
            if ( Object.keys(pinsInUse).length !== 0 ) {
                return "**Pins in use** : "+Object.keys(pinsInUse);
            }
            else { return ""; }
        },
        label: function() {
            var suf = "";
            if (this.intype === "up") { suf = "↑ "}
            if (this.intype === "down") { suf = "↓ "}
            return this.name || "PIN: "+suf+this.pin ;
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        outputLabels: function() { return "GPIO"+this.pin; },
        oneditprepare: function() {
            var that = this
            var _piModel = null
            var getPiModel = function(){
              return new Promise( (resolve, reject) => {
                if(_piModel !== null){
                  resolve(_piModel)
                  return
                }
                fetch(`/rpi-gpio/${that.id}`).then(response => {
                  if(response.ok){
                    return response.json()
                  } else {
                    throw new Error('response not ok')
                  }
                })
                .then(hardware => {
                  if(hardware.gpio_type){
                    _piModel = hardware.gpio_type
                    that.piModel = hardware.gpio_type
                    $("#node-input-piModel").val(that.piModel);
                  } else {
                    _piModel = null
                  }
                })
                .catch(_ => {
                  _piModel = null
                })
                .finally(_ =>{
                  if(_piModel !== null){
                    resolve(_piModel)
                  } else {
                    reject()
                  }
                })
              })
            }
            getPiModel()
            .then(piModel => {
              $('.rpi-gpio-pinTable').hide()
              $(`#pinform_${piModel}`).show()
            })
            .catch(_ => {
              $('.rpi-gpio-pinTable').hide()
              $('#pinform_notSuppoerted').show()
            })
            var tabs = RED.tabs.create({
              id: "ttbd-node-gpio-in-tabs",
              onchange: function(tab) {
                $("#ttbd-node-gpio-in-tabs-content").children().hide();
                $("#" + tab.id).show();
              }
            });
            tabs.addTab({
              id: "ttbd-node-gpio-in-tab-configuration",
              label: 'Pins'
            });
            tabs.addTab({
              id: "ttbd-node-gpio-in-tab-advanced",
              label: 'advanced'
            });
            var pinnow = this.pin;
            var pintip = this._("rpi-gpio.tip.pin");
            var pinname = this._("rpi-gpio.pinname");
            var alreadyuse = this._("rpi-gpio.alreadyuse");
            var alreadyset = this._("rpi-gpio.alreadyset");
            $.getJSON('rpi-pins/'+this.id,function(data) {
                pinsInUse = data || {};
                $('#pin-tip').html(pintip + Object.keys(data));
            });
            $("#node-input-pin").change(function() {
                getPiModel()
                .then(piModel => {
                    if ($("#node-input-pin").val()) {
                        $(`#pinform_${piModel} input[value=${$("#node-input-pin").val()}]`).prop('checked', true);
                    }
                    var pinnew = $("#node-input-pin").val();
                    if ((pinnew) && (pinnew !== pinnow)) {
                        if (pinsInUse.hasOwnProperty(pinnew)) {
                            RED.notify(pinname+" "+pinnew+" "+alreadyuse,"warn");
                        }
                        pinnow = pinnew;
                    }
                })
                .catch()
            });
            $('#pinform_b input').on('change', function() {
                let pinnew = $("#pinform_b input[type='radio']:checked").val();
                $("#node-input-pin").val(pinnew);
            });
            $('#pinform_cm input').on('change', function() {
                let pinnew = $("#pinform_cm input[type='radio']:checked").val();
                $("#node-input-pin").val(pinnew);
            });
        },
        oneditsave: function(){
          let pinnow = this.pin;
          let pinnew = $("#node-input-pin").val();
          if(pinnew && pinew != pinnow){
            this.pin = pinnew
            this.dirty = true
            this.changed = true
            RED.nodes.dirty(true)
          }
        }
    });
</script>

<script type="text/x-red" data-template-name="rpi-gpio out">
  <div class="form-row">
    <ul style="background: #fff; min-width: 600px; margin-bottom: 20px;" id="ttbd-node-gpio-out-tabs"></ul>
  </div>
  <div id="ttbd-node-gpio-out-tabs-content" style="min-height: 170px;">
    <div id="ttbd-node-gpio-out-tab-configuration" style="display:none">
      <div class="form-row" style="min-width: 540px">
          <label><i class="fa fa-circle"></i> <span data-i18n="rpi-gpio.pinname"></span></label>
          <input type="text" id="node-input-pin" style="display:none;">
          <input type="hidden" id="node-input-piModel">
          <div class="rpi-gpio-pinTable" id="pinform_cm" style="display:none;">
              <div class="ledTableBody">
                  <div class="pinTableRow">
                      <div class="ledTableCell pinColorLed lastrow firstcol"><label>Led 1 <input type="radio" name="pins" value="52"></label></div>
                      <div class="ledTableCell pinColorLed lastrow"><label>Led 2 <input type="radio" name="pins" value="54"></label></div>
                      <div class="ledTableCell pinColorLed lastrow"><label>Led 3 <input type="radio" name="pins" value="58"></label></div>
                  </div>
              </div>
              <div class="pinTableBody">
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO"><label>TIC 1 <input disabled type="radio" name="pins" value=""></label></div>
                      <div class="pinTableCellR pinColorPower"><label><input disabled type="radio" name="pins" value=""> 24VDC Power</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO"><label>TIC 2 <input disabled type="radio" name="pins" value=""></label></div>
                      <div class="pinTableCellR pinColorPower"><label><input disabled type="radio" name="pins" value=""> 24VDC Power</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorDual"><label>ES 4/20mA A <input disabled type="radio" name="pins" value=""></label></div>
                      <div class="pinTableCellR pinColorGround"><label><input disabled type="radio" name="pins" value=""> Ground</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorDual"><label>ES 4/20mA B <input disabled type="radio" name="pins" value=""></label></div>
                      <div class="pinTableCellR pinColorGround"><label><input disabled type="radio" name="pins" value=""> Ground</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorDual"><label>+ RS485 <input disabled type="radio" name="pins" value=""></label></div>
                      <div class="pinTableCellR pinColorGround"><label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorDual"><label>- RS485 <input disabled type="radio" name="pins" value=""></label></div>
                      <div class="pinTableCellR pinColorGround lastrow"><label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO"><label>- ES TOR1 <input id="pinTable-pin-28" type="radio" name="pins" value="28"></label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO"><label>+ ES TOR1 <input disabled type="radio" name="pins" value=""></label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO2"><label>- ES TOR2 <input id="pinTable-pin-30" type="radio" name="pins" value="30"></label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO2"><label>+ ES TOR2 <input disabled type="radio" name="pins" value=""></label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO"><label>- ES TOR3 <input id="pinTable-pin-34" type="radio" name="pins" value="34"></label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO"><label>+ ES TOR3 <input disabled type="radio" name="pins" value=""></label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO2"><label>NC - Relais 1 <input disabled type="radio" name="pins" value=""></label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO2"><label>COM - Relais 1 <input id="pinTable-pin-21" type="radio" name="pins" value="21"></label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO2"><label>NO - Relais 1 <input disabled type="radio" name="pins" value=""></label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO"><label>NC - Relais 2 <input disabled type="radio" name="pins" value=""></label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO"><label>COM - Relais 2 <input id="pinTable-pin-45" type="radio" name="pins" value="45"></label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO lastrow"><label>NO - Relais 2 <input disabled type="radio" name="pins" value=""></label></div>
                  </div>
              </div>
          </div>
          <div class="rpi-gpio-pinTable" id="pinform_b" style="display:none;">
              <div class="pinTableBody">
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorPower"><label>3.3V Power - 1 <input disabled type="radio" name="pins" value=""></label></div>
                      <div class="pinTableCellR pinColorPower"><label><input disabled type="radio" name="pins" value=""> 2 - 5V Power</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorDual"><label for="pinTable-pin-3">SDA1 - GPIO02 - 3 <input id="pinTable-pin-3" type="radio" name="pins" value="3"></label></div>
                      <div class="pinTableCellR pinColorPower"><label><input disabled type="radio" name="pins" value=""> 4 - 5V Power</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorDual"><label for="pinTable-pin-5">SCL1 - GPIO03 - 5 <input id="pinTable-pin-5" type="radio" name="pins" value="5"></label></div>
                      <div class="pinTableCellR pinColorGround"><label><input disabled type="radio" name="pins" value=""> 6 - Ground</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO"><label for="pinTable-pin-7">GPIO04 - 7 <input id="pinTable-pin-7" type="radio" name="pins" value="7"></label></div>
                      <div class="pinTableCellR pinColorDual"><label for="pinTable-pin-8"><input id="pinTable-pin-8" type="radio" name="pins" value="8"> 8 - GPIO14 - TxD</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGround"><label>Ground - 9 <input disabled type="radio" name="pins" value=""></label></div>
                      <div class="pinTableCellR pinColorDual"><label for="pinTable-pin-10"><input id="pinTable-pin-10" type="radio" name="pins" value="10"> 10 - GPIO15 - RxD</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO"><label for="pinTable-pin-11">GPIO17 - 11 <input id="pinTable-pin-11" type="radio" name="pins" value="11"></label></div>
                      <div class="pinTableCellR pinColorGPIO"><label for="pinTable-pin-12"><input id="pinTable-pin-12" type="radio" name="pins" value="12"> 12 - GPIO18</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO"><label for="pinTable-pin-13">GPIO27 - 13 <input id="pinTable-pin-13" type="radio" name="pins" value="13"></label></div>
                      <div class="pinTableCellR pinColorGround"><label><input disabled type="radio" name="pins" value=""> 14 - Ground</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO"><label for="pinTable-pin-15">GPIO22 - 15 <input id="pinTable-pin-15" type="radio" name="pins" value="15"></label></div>
                      <div class="pinTableCellR pinColorGPIO"><label for="pinTable-pin-16"><input id="pinTable-pin-16" type="radio" name="pins" value="16"> 16 - GPIO23</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorPower"><label>3.3V Power - 17 <input disabled type="radio" name="pins" value=""></label></div>
                      <div class="pinTableCellR pinColorGPIO"><label for="pinTable-pin-18"><input id="pinTable-pin-18" type="radio" name="pins" value="18"> 18 - GPIO24</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorDual"><label for="pinTable-pin-19">MOSI - GPIO10 - 19 <input id="pinTable-pin-19" type="radio" name="pins" value="19"></label></div>
                      <div class="pinTableCellR pinColorGround"><label><input disabled type="radio" name="pins" value=""> 20 - Ground</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorDual"><label for="pinTable-pin-21">MISO - GPIO09 - 21 <input id="pinTable-pin-21" type="radio" name="pins" value="21"></label></div>
                      <div class="pinTableCellR pinColorGPIO"><label for="pinTable-pin-22"><input id="pinTable-pin-22" type="radio" name="pins" value="22"> 22 - GPIO25</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorDual"><label for="pinTable-pin-23">SCLK - GPIO11 - 23 <input id="pinTable-pin-23" type="radio" name="pins" value="23"></label></div>
                      <div class="pinTableCellR pinColorDual"><label for="pinTable-pin-24"><input id="pinTable-pin-24" type="radio" name="pins" value="24"> 24 - GPIO8 - CE0</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGround"><label>Ground - 25 <input disabled type="radio" name="pins" value=""></label></div>
                      <div class="pinTableCellR pinColorDual"><label for="pinTable-pin-26"><input id="pinTable-pin-26" type="radio" name="pins" value="26"> 26 - GPIO7 - CE1</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorSD"><label>SD - 27 <input disabled type="radio" name="pins" value=""></label></div>
                      <div class="pinTableCellR pinColorSD"><label><input disabled type="radio" name="pins" value=""> 28 - SC</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO"><label for="pinTable-pin-29">GPIO05 - 29 <input id="pinTable-pin-29" type="radio" name="pins" value="29"></label></div>
                      <div class="pinTableCellR pinColorGround"><label><input disabled type="radio" name="pins" value=""> 30 - Ground</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO"><label for="pinTable-pin-31">GPIO06 - 31 <input id="pinTable-pin-31" type="radio" name="pins" value="31"></label></div>
                      <div class="pinTableCellR pinColorGPIO"><label for="pinTable-pin-32"><input id="pinTable-pin-32" type="radio" name="pins" value="32"> 32 - GPIO12</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO"><label for="pinTable-pin-33">GPIO13 - 33 <input id="pinTable-pin-33" type="radio" name="pins" value="33"></label></div>
                      <div class="pinTableCellR pinColorGround"><label><input disabled type="radio" name="pins" value=""> 34 - Ground</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO"><label for="pinTable-pin-35">GPIO19 - 35 <input id="pinTable-pin-35" type="radio" name="pins" value="35"></label></div>
                      <div class="pinTableCellR pinColorGPIO"><label for="pinTable-pin-36"><input id="pinTable-pin-36" type="radio" name="pins" value="36"> 36 - GPIO16</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGPIO"><label for="pinTable-pin-37">GPIO26 - 37 <input id="pinTable-pin-37" type="radio" name="pins" value="37"></label></div>
                      <div class="pinTableCellR pinColorGPIO"><label for="pinTable-pin-38"><input id="pinTable-pin-38" type="radio" name="pins" value="38"> 38 - GPIO20</label></div>
                  </div>
                  <div class="pinTableRow">
                      <div class="pinTableCellL pinColorGround lastrow"><label>Ground - 39 <input disabled type="radio" name="pins" value=""></label></div>
                      <div class="pinTableCellR pinColorGPIO lastrow"><label for="pinTable-pin-40"><input id="pinTable-pin-40" type="radio" name="pins" value="40"> 40 - GPIO21</label></div>
                  </div>
              </div>
          </div>
      </div>
      <div class="form-row" id="node-set-tick">
          <label>&nbsp;</label>
          <input type="checkbox" id="node-input-set" style="display: inline-block; width: auto; vertical-align: top;">
          <label for="node-input-set" style="width: 70%;"><span data-i18n="rpi-gpio.label.initpin"></span></label>
      </div>
      <div class="form-row" id="node-set-state">
          <label for="node-input-level">&nbsp;</label>
          <select id="node-input-level" style="width: 250px;">
              <option value="0" data-i18n="rpi-gpio.initpin0"></option>
              <option value="1" data-i18n="rpi-gpio.initpin1"></option>
          </select>
      </div>
      <div class="form-row">
          <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="rpi-gpio.label.name"></span></label>
          <input type="text" id="node-input-name" data-i18n="[placeholder]rpi-gpio.label.name">
      </div>
      <div class="form-tips" id="pin-tip"><span data-i18n="[html]rpi-gpio.tip.pin"></span></div>
      <div class="form-tips" id="dig-tip"><span data-i18n="[html]rpi-gpio.tip.dig"></span></div>
    </div>
    <div id="ttbd-node-gpio-out-tab-advanced" style="display:none">
      <div class="form-row">
        <label for="node-input-broker"><i class="fa fa-globe"></i> <span>Broker</span></label>
        <input type="text" id="node-input-broker">
      </div>
    </div>
  </div>
</script>

<script type="text/x-red" data-help-name="rpi-gpio out">
    <p>Raspberry Pi output node. Can be used in Digital or PWM modes.
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">number | string | boolean</span></dt>
    </dl>
    <h3>Details</h3>
    <p>Digital mode - expects a <code>msg.payload</code> with either a 0 or 1 (or true or false),
    and will set the selected physical pin high or low depending on the value passed in.</p>
    <p>The initial value of the pin at deploy time can also be set to 0 or 1.</p>
</script>

<script type="text/javascript">
    var bcm2pin = {}
    bcm2pin.b = {
        "2":"3", "3":"5", "4":"7", "14":"8", "15":"10", "17":"11", "18":"12", "27":"13", "22":"15",
        "23":"16", "24":"18", "10":"19", "9":"21", "25":"22", "11":"23", "8":"24", "7":"26",
        "5":"29", "6":"31", "12":"32", "13":"33", "19":"35", "16":"36", "26":"37", "20":"38", "21":"40"
    };
    var pinsInUse = {};
    RED.nodes.registerType('rpi-gpio out',{
        category: 'hardware',
        color:"#c6dbef",
        defaults: {
            name: { value:"" },
            pin: { value:"",required:true,validate:RED.validators.number() },
            set: { value:"" },
            level: { value:"0" },
            broker: {value: "MQTT.Localhost", type: "mqtt-broker", required: true},
            piModel: { value:"" },
        },
        inputs:1,
        outputs:0,
        icon: "gpio.png",
        info: function() {
            if ( Object.keys(pinsInUse).length !== 0 ) {
                return "**Pins in use** : "+Object.keys(pinsInUse);
            }
            else { return ""; }
        },
        align: "right",
        label: function() {
            var suf = "";
            if (this.set == true) { suf = (this.level === "1") ? " ¹" : " ₀"; }
            return this.name||"PIN: "+ this.pin + suf ;
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        inputLabels: function() { return "GPIO"+this.pin; },
        oneditprepare: function() {
            var that = this
            var _piModel = null
            var getPiModel = function(){
              return new Promise( (resolve, reject) => {
                if(_piModel !== null){
                  resolve(_piModel)
                  return
                }
                fetch(`/rpi-gpio/${that.id}`).then(response => {
                  if(response.ok){
                    return response.json()
                  } else {
                    throw new Error('response not ok')
                  }
                })
                .then(hardware => {
                  if(hardware.gpio_type){
                    _piModel = hardware.gpio_type
                    that.piModel = hardware.gpio_type
                    $("#node-input-piModel").val(that.piModel);
                  } else {
                    _piModel = null
                  }
                })
                .catch(_ => {
                  _piModel = null
                })
                .finally(_ =>{
                  if(_piModel !== null){
                    resolve(_piModel)
                  } else {
                    reject()
                  }
                })
              })
            }
            getPiModel()
            .then(piModel => {
              $('.rpi-gpio-pinTable').hide()
              $(`#pinform_${piModel}`).show()
            })
            .catch(_ => {
              $('.rpi-gpio-pinTable').hide()
              $('#pinform_notSuppoerted').show()
            })
            var tabs = RED.tabs.create({
              id: "ttbd-node-gpio-out-tabs",
              onchange: function(tab) {
                $("#ttbd-node-gpio-out-tabs-content").children().hide();
                $("#" + tab.id).show();
              }
            });
            tabs.addTab({
              id: "ttbd-node-gpio-out-tab-configuration",
              label: 'Pins'
            });
            tabs.addTab({
              id: "ttbd-node-gpio-out-tab-advanced",
              label: 'advanced'
            });
            var pinnow = this.pin;
            var pintip = this._("rpi-gpio.tip.pin");
            var pinname = this._("rpi-gpio.pinname");
            var alreadyuse = this._("rpi-gpio.alreadyuse");
            var alreadyset = this._("rpi-gpio.alreadyset");
            if (!$("#node-input-out").val()) { $("#node-input-out").val("out"); }
            $.getJSON('rpi-pins/'+this.id,function(data) {
                pinsInUse = data || {};
                $('#pin-tip').html(pintip + Object.keys(data));
            });
            $("#node-input-pin").change(function() {
                getPiModel()
                .then(piModel => {
                    if ($("#node-input-pin").val()) {
                        $(`#pinform_${piModel} input[value=${$("#node-input-pin").val()}]`).prop('checked', true);
                    }
                    var pinnew = $("#node-input-pin").val();
                    if ((pinnew) && (pinnew !== pinnow)) {
                        if (pinsInUse.hasOwnProperty(pinnew)) {
                            RED.notify(pinname+" "+pinnew+" "+alreadyuse,"warn");
                        }
                        pinnow = pinnew;
                    }
                })
                .catch()
            });
            var setstate = function () {
                if ($('#node-input-set').is(":checked")) {
                    $("#node-set-state").show();
                } else {
                    $("#node-set-state").hide();
                }
            };
            $("#node-input-set").change(function () { setstate(); });
            setstate();
            $('#pinform_b input').on('change', function() {
                let pinnew = $("#pinform_b input[type='radio']:checked").val();
                $("#node-input-pin").val(pinnew);
            });
            $('#pinform_cm input').on('change', function() {
                let pinnew = $("#pinform_cm input[type='radio']:checked").val();
                $("#node-input-pin").val(pinnew);
            });
        },
        oneditsave: function(){
          let pinnow = this.pin;
          let pinnew = $("#node-input-pin").val();
          if(pinnew && pinew != pinnow){
            this.pin = pinnew
            this.dirty = true
            this.changed = true
            RED.nodes.dirty(true)
          }
        }
    });
</script>
